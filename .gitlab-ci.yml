stages:
  - build
  - push
  - deploy

variables:
  # Configuration de ton registre Docker
  REGISTRY: "10.2.0.106:5001"
  IMAGE_NAME: "harvester"
  TAG: "latest"

# Étape de build
build:
  stage: build
  script:
    - docker build -t $REGISTRY/$IMAGE_NAME:$TAG .

# Étape de push (pousser l'image vers le registre Docker)
push:
  stage: push
  script:
    - docker push $REGISTRY/$IMAGE_NAME:$TAG
  only:
    - main  # Pousser l'image uniquement si on est sur la branche 'main' (ou 'master')

# Étape de déploiement (optionnel, selon ton besoin)
deploy:
  stage: deploy
  script:
    - echo "$SSH_PRIVATE_KEY" > /tmp/private_key && chmod 600 /tmp/private_key
    - eval $(ssh-agent -s) && ssh-add /tmp/private_key
    - ssh -o StrictHostKeyChecking=no julien@10.2.0.106 \
        'export REGISTRY="$REGISTRY" IMAGE_NAME="$IMAGE_NAME" TAG="$TAG" && \
        docker pull $REGISTRY/$IMAGE_NAME:$TAG && \
        docker run -d --name $IMAGE_NAME $REGISTRY/$IMAGE_NAME:$TAG'
  only:
    - main